stages:
  - validate

variables:
  HELM_GUARD_UI_URL: "https://helm-guard-ui.my-company.com"

helm_guard_validate:
  stage: validate
  image: node:20

  script:
    - echo "ğŸ§© Installing helm-guard CLI dependencies"
    - cd cli
    - npm ci
    - npm run build

    - echo "ğŸ› ï¸ Running helm-guard validation"
    - |
      ARGS="--chart \"$HELM_CHART_PATH\" --namespace \"$HELM_NAMESPACE\" --output ../report.json"

      if [ -n "$HELM_GUARD_MODE" ]; then
        ARGS="$ARGS --mode \"$HELM_GUARD_MODE\""
      fi

      if [ -n "$HELM_RELEASE_NAME" ]; then
        ARGS="$ARGS --release \"$HELM_RELEASE_NAME\""
      fi

      if [ -n "$HELM_VALUES_FILES" ]; then
        for values_file in $HELM_VALUES_FILES; do
          ARGS="$ARGS --values \"$values_file\""
        done
      fi

      echo "ğŸ” Comparing Helm desired state vs live OpenShift resources"
      eval node dist/index.js $ARGS

  artifacts:
    when: always
    paths:
      - report.json
    expire_in: 7 days

  after_script:
    - |
      REPORT_URL="${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/report.json"

      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "ğŸ›¡ï¸  HELM-GUARD REPORT READY"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo ""
      echo "ğŸ“Š Validation report:"
      echo "ğŸ‘‰ ${HELM_GUARD_UI_URL}/?reportUrl=${REPORT_URL}"
      echo ""
      echo "â„¹ï¸  Tip:"
      echo "   âœ… No output issues â†’ safe to deploy"
      echo "   âš ï¸  WARN only â†’ review recommended"
      echo "   âŒ FAIL â†’ deployment should be blocked"
      echo ""
