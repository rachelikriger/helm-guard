stages:
  - validate

variables:
  HELM_GUARD_UI_URL: "https://helm-guard-ui.my-company.com"

helm_guard_validate:
  stage: validate
  image: node:20

  script:
    - echo "ğŸ§© Installing helm-guard CLI dependencies"
    - ROOT_DIR="${CI_PROJECT_DIR:-$PWD}"
    - cd cli
    - npm ci
    - npm run build

    - echo "ğŸ›¡ï¸ Running helm-guard validation"
    - |
      resolve_path() {
        case "$1" in
          /*) printf '%s\n' "$1" ;;
          *)  printf '%s\n' "$ROOT_DIR/$1" ;;
        esac
      }

      CHART_PATH="$(resolve_path "$HELM_CHART_PATH")"

      set -- \
        --chart "$CHART_PATH" \
        --namespace "$HELM_NAMESPACE" \
        --output ../report.json

      if [ -n "$HELM_GUARD_MODE" ]; then
        set -- "$@" --mode "$HELM_GUARD_MODE"
      fi

      if [ -n "$HELM_RELEASE_NAME" ]; then
        set -- "$@" --release "$HELM_RELEASE_NAME"
      fi

      if [ -n "$HELM_VALUES_FILES" ]; then
        for values_file in $HELM_VALUES_FILES; do
          VALUES_PATH="$(resolve_path "$values_file")"
          set -- "$@" --values "$VALUES_PATH"
        done
      fi

      echo "ğŸ” Comparing Helm desired state vs live OpenShift resources"
      node dist/index.js "$@"

  artifacts:
    when: always
    paths:
      - report.json
    expire_in: 7 days

  after_script:
    - |
      REPORT_URL="${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/report.json"

      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "ğŸ“„ HELM-GUARD REPORT READY"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo ""
      echo "ğŸ”— View validation report:"
      echo "ğŸ‘‰ ${HELM_GUARD_UI_URL}/?reportUrl=${REPORT_URL}"
      echo ""
      echo "â„¹ï¸  Interpretation guide:"
      echo "   âœ… No findings        â†’ Safe to deploy"
      echo "   âš ï¸  WARN only         â†’ Review recommended"
      echo "   âŒ FAIL               â†’ Deployment should be blocked"
      echo ""
