# helm-guard

**helm-guard** is a guardrail tool for Helm adoption on OpenShift. It validates that the manifests produced by `helm template` match the live resources currently deployed in an OpenShift cluster **before** any real `helm upgrade` is executed. The project includes:

- `cli/` - TypeScript Node.js CLI that performs the comparison.
- `ui/` - React (Vite) web viewer that visualizes a saved JSON report (read-only).

> Important: helm-guard does **not** deploy anything. It only compares and reports.

## How It Works (End-to-End Flow)

1. Render Helm output: CLI runs `helm template`, parses multi-document YAML into `K8sResource[]`.
2. Fetch live OpenShift resources: CLI runs `oc get ... -o yaml` (namespace-scoped), parses into `K8sResource[]`.
3. Normalize: drops system-generated fields, sorts arrays where possible for deterministic comparisons.
4. Compare: matches resources by `<Kind>/<namespace>/<name>` and produces `MATCH`, `DRIFT`, `MISSING_LIVE`, or `MISSING_HELM`. Each diff is tagged `WARN` or `FAIL`.
5. Report: prints a readable summary with exit code; can also emit a JSON report for the UI.

## CLI (cli/)

### Install & Run

```bash
cd cli
npm install
npm run build
node dist/index.js --chart ./path/to/chart --namespace prod
```

### Options

- `--chart <path>`: path to your Helm chart directory
- `--namespace <ns>`: namespace to compare against
- `--strict`: strict mode (treat diffs as failures)
- `--output <file>`: write a JSON report to the given path

### Exit Codes

- `0` - all resources matched (no diffs)
- `1` - warnings found (drift exists but not considered a failure)
- `2` - failures found OR missing resources
- `3` - runtime error

### About Helm Output Size

Helm charts may produce hundreds of YAML resources. This is supported because `helm template` output is parsed into an in-memory list of resources. Comparison is done per resource, not per file.

## UI Viewer (ui/)

The UI is a read-only report viewer for JSON reports generated by the CLI (`--output`). It does not connect to OpenShift and does not run Helm.

### Run the UI locally

```bash
cd ui
npm install
npm run dev
```

Then upload a report JSON file (for example: `sample-report.json`).

### Build the UI for production

```bash
cd ui
npm run build
```

## Report Format (Consumed by UI)

```json
{
  "timestamp": "ISO",
  "config": { "helmChart": "...", "namespace": "...", "strictMode": false },
  "summary": {
    "total": 0,
    "matched": 0,
    "drifted": 0,
    "missingLive": 0,
    "missingHelm": 0,
    "warnings": 0,
    "failures": 0
  },
  "results": [
    {
      "resourceKey": "Kind/ns/name",
      "status": "MATCH|DRIFT|MISSING_LIVE|MISSING_HELM",
      "differences": [
        { "path": "...", "helmValue": {}, "liveValue": {}, "action": "WARN|FAIL" }
      ]
    }
  ]
}
```

## Notes

* Intended for local use and as a CI stage before deployment.
* No backend, no database, no approvals, no deployment logic. 
