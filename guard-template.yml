stages:
    - validate

variables:
    HELM_GUARD_UI_URL: 'https://helm-guard-ui.my-company.com'
    HELM_GUARD_CLI_IMAGE: 'image-registry.openshift.svc:5000/<ns>/helm-guard-cli:stable'
    HELM_CHART_PATH: '$CI_PROJECT_DIR'

.helm_guard_validate:
    stage: validate
    image: '$HELM_GUARD_CLI_IMAGE'

    script:
        - |
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ›¡ï¸  HELM-GUARD | Validation Started"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""

            set -- \
              --chart "$HELM_CHART_PATH" \
              --namespace "$HELM_NAMESPACE" \
              --output report.json

            if [ -n "$HELM_GUARD_MODE" ]; then
              set -- "$@" --mode "$HELM_GUARD_MODE"
            fi

            if [ -n "$HELM_RELEASE_NAME" ]; then
              set -- "$@" --release "$HELM_RELEASE_NAME"
            fi

            if [ -n "$HELM_VALUES_FILES" ]; then
              for values_file in $HELM_VALUES_FILES; do
                set -- "$@" --values "$values_file"
              done
            fi

            if [ -n "$HELM_SET_VALUES" ]; then
              for set_value in $HELM_SET_VALUES; do
                set -- "$@" --set "$set_value"
              done
            fi

            echo "ğŸ” Comparing Helm desired state vs live OpenShift resources"
            echo ""
            helm-guard "$@"

    artifacts:
        when: always
        paths:
            - report.json
        expire_in: 7 days

    after_script:
        - |
            REPORT_URL="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/jobs/${CI_JOB_ID}/artifacts/report.json"
            REPORT_URL_ENC=$(node -e "console.log(encodeURIComponent(process.argv[1]))" "$REPORT_URL")
            REPORT_LINK="${HELM_GUARD_UI_URL}/?reportUrl=${REPORT_URL_ENC}"

            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“„ HELM-GUARD | Report Ready"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ğŸ”— View validation report:"
            echo "ğŸ‘‰ $REPORT_LINK"
            echo ""
            echo "â„¹ï¸  Interpretation guide:"
            echo "   âœ… No findings        â†’ Safe to deploy"
            echo "   âš ï¸  WARN only         â†’ Review recommended"
            echo "   âŒ FAIL               â†’ Deployment should be blocked"
            echo ""
